<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root{
            --primary:#409EFF; --primary-hover:#3a8ee6;
            --bg:#f3f5f7; --card:#fff; --border:#e6e8eb; --text:#2f3440;
            --danger:#f56c6c; --success:#67C23A; --info:#5ca7ff; --purple:#8a7cfb;
        }
        *{box-sizing:border-box}
        body{margin:0;font:14px/1.6 "Microsoft YaHei",Segoe UI,Arial; background:var(--bg); color:var(--text);}
        .layout{display:flex; min-height:100vh;}
        .sider{width:220px;background:#2d3a4b;color:#cfd8e3;display:flex;flex-direction:column}
        .sider .logo{padding:18px 16px;font-weight:700;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.06)}
        .sider .menu{padding:10px}
        .sider .menu a{display:flex; align-items:center; gap:8px; padding:10px 12px; color:#cfd8e3; text-decoration:none; border-radius:6px}
        .sider .menu a.active,.sider .menu a:hover{background:rgba(255,255,255,.08); color:#fff}
        .main{flex:1; display:flex; flex-direction:column}
        .topbar{height:56px;background:linear-gradient(135deg,#58a6ff,#409eff);color:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 18px; box-shadow:0 2px 8px rgba(0,0,0,.08)}
        .topbar .title{font-size:18px; font-weight:700}
        .container{padding:18px; max-width:1200px; margin:0 auto; width:100%}
        .card{background:var(--card); border:1px solid var(--border); border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-bottom:16px}
        .card .hd{padding:12px 16px; border-bottom:1px solid var(--border); font-weight:700; display:flex; align-items:center; gap:10px}
        .card .bd{padding:14px 16px}
        input{height:36px; padding:0 10px; border:1px solid var(--border); border-radius:6px; outline:none; transition:.2s}
        input:focus{border-color:var(--primary); box-shadow:0 0 0 2px rgba(64,158,255,.15)}
        .btn{height:34px; padding:0 14px; border:none; border-radius:6px; cursor:pointer; color:#fff; display:inline-flex; align-items:center; gap:6px}
        .btn.primary{background:var(--primary)} .btn.primary:hover{background:var(--primary-hover)}
        .btn.gray{background:#a8b0bb} .btn.gray:hover{background:#9098a4}
        .btn.danger{background:var(--danger)} .btn.success{background:var(--success)} .btn.info{background:var(--info)} .btn.purple{background:var(--purple)}
        .toolbar{display:flex; gap:10px; flex-wrap:wrap}
        .grid{width:100%; border-collapse:collapse; overflow:hidden; border-radius:10px}
        .grid th,.grid td{padding:10px 12px; border-bottom:1px solid var(--border); background:#fff}
        .grid th{background:#f6f8fb; text-align:left}
        tr:hover td{background:#f8fbff}
        .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
        .right{margin-left:auto}
        .hidden{display:none}
        .muted{color:#9aa3af}
        .footer{text-align:center;color:#9aa3af;padding:12px}
        .tag{font-size:12px; padding:2px 8px; background:#eef2ff; color:#5a67d8; border-radius:999px}
        .login-panel{max-width:420px; margin:60px auto}
        .login-panel .bd{display:flex; gap:10px; flex-wrap:wrap}
        .login-panel input{flex:1}
        .pagination{display:flex; gap:6px; align-items:center}
        .pagination button{height:28px; padding:0 10px; border-radius:6px; border:1px solid var(--border); background:#fff; cursor:pointer}
        .pagination .current{background:var(--primary); color:#fff; border-color:var(--primary)}
        /* æŠ˜å è¡¨å• */
        .collapsed{display:none}
    </style>
</head>
<body>
<div class="layout">

    <!-- ä¾§è¾¹æ  -->
    <aside class="sider">
        <div class="logo">ğŸ“’ <span>é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</span></div>
        <nav class="menu">
            <a href="#/home" id="nav-home" class="active">ğŸ“ æ•°æ®ç®¡ç†</a>
            <a href="#/user" id="nav-user">ğŸ‘¤ ç”¨æˆ·</a>
            <a href="#/about" id="nav-about">â„¹ï¸ å…³äºç³»ç»Ÿ</a>
        </nav>
    </aside>

    <!-- ä¸»åŒºåŸŸ -->
    <section class="main">
        <div class="topbar">
            <div class="title">ğŸ“‡ è”ç³»äººç®¡ç†</div>
            <div class="flex">
                <span class="tag" id="whoami">æœªç™»å½•</span>
                <button class="btn gray" id="btn-logout" title="é€€å‡ºç™»å½•">é€€å‡º</button>
            </div>
        </div>
        <div class="container">

            <!-- ç™»å½•é¡µ -->
            <div id="page-login" class="login-panel card">
                <div class="hd">ç”¨æˆ·ç™»å½• / æ³¨å†Œ</div>
                <div class="bd">
                    <input id="lg-username" placeholder="ç”¨æˆ·å" style="flex:1 0 160px">
                    <input id="lg-password" type="password" placeholder="å¯†ç " style="flex:1 0 160px">
                    <div class="flex">
                        <button class="btn primary" id="btn-login">ç™»å½•</button>
                        <button class="btn success" id="btn-register">æ³¨å†Œ</button>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç®¡ç†é¡µ -->
            <div id="page-home" class="hidden">
                <!-- å·¥å…·æ¡ -->
                <div class="card">
                    <div class="hd">å·¥å…·æ </div>
                    <div class="bd flex">
                        <div class="toolbar">
                            <button class="btn danger" id="btn-batch-del">æ‰¹é‡åˆ é™¤</button>
                            <button class="btn success" id="btn-new">æ–°å¢</button>
                            <label class="btn info" for="csvFile">æ‰¹é‡å¯¼å…¥</label>
                            <input type="file" id="csvFile" accept=".csv" class="hidden">
                            <button class="btn purple" id="btn-export">æ‰¹é‡å¯¼å‡º</button>
                        </div>
                        <div class="right flex">
                            <input id="kw" placeholder="è¯·è¾“å…¥åç§°/ç”µè¯æœç´¢" style="width:240px">
                            <button class="btn primary" id="btn-search">æŸ¥è¯¢</button>
                        </div>
                    </div>
                </div>

                <!-- æ·»åŠ /ç¼–è¾‘ï¼ˆé»˜è®¤æŠ˜å ï¼‰ -->
                <div class="card collapsed" id="panel-edit">
                    <div class="hd">æ·»åŠ  / ç¼–è¾‘è”ç³»äºº</div>
                    <div class="bd">
                        <form id="form" class="flex">
                            <input type="hidden" id="id">
                            <input id="name" placeholder="å§“åï¼ˆå¿…å¡«ï¼‰" required style="flex:1 0 160px">
                            <input id="phone" placeholder="ç”µè¯ï¼ˆå¿…å¡«ï¼‰" required style="flex:1 0 160px">
                            <input id="email" placeholder="é‚®ç®±ï¼ˆå¯é€‰ï¼‰" style="flex:2 0 200px">
                            <input id="note" placeholder="åœ°å€ / å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰" style="flex:3 0 300px">
                            <div class="flex">
                                <button type="submit" class="btn primary">ğŸ’¾ ä¿å­˜</button>
                                <button type="button" id="resetBtn" class="btn gray">ğŸ§¹ é‡ç½®</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="card">
                    <div class="hd">è”ç³»äººåˆ—è¡¨</div>
                    <div class="bd">
                        <table class="grid" id="tbl">
                            <thead>
                            <tr>
                                <th style="width:42px"><input type="checkbox" id="chk-all"></th>
                                <th style="width:72px">åºå·</th>
                                <th>å§“å</th><th>ç”µè¯</th><th>é‚®ç®±</th><th>å¤‡æ³¨</th><th style="width:140px">æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                        <div class="flex" style="margin-top:10px">
                            <div class="muted" id="summary">å…± 0 æ¡</div>
                            <div class="right pagination" id="pager"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·é¡µ -->
            <div id="page-user" class="card hidden">
                <div class="hd">ç”¨æˆ·ä¿¡æ¯</div>
                <div class="bd">
                    <div>å½“å‰ç”¨æˆ·ï¼š<b id="user-name">-</b></div>
                    <div class="muted" style="margin-top:8px">è¿™é‡Œåªå±•ç¤ºç™»å½•ç”¨æˆ·ï¼›è‹¥éœ€ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼Œå¯åç»­æ‰©å±•ã€‚</div>
                </div>
            </div>

            <!-- å…³äºé¡µ -->
            <div id="page-about" class="card hidden">
                <div class="hd">å…³äºç³»ç»Ÿ</div>
                <div class="bd">
                    <div class="flex">
                        <button class="btn primary" id="btn-health">æ£€æŸ¥åç«¯è¿é€šæ€§</button>
                        <span id="health-text" class="muted"></span>
                    </div>
                    <p class="muted" style="margin-top:12px">ç‰ˆæœ¬ï¼šå‰ç«¯åŸç”Ÿ HTML/JSï¼›åç«¯ Node.js + Express + MySQLï¼ˆJWT é‰´æƒï¼‰ã€‚</p>
                </div>
            </div>

            <div class="footer">Â© 2025 é€šè®¯å½•ç®¡ç†ç³»ç»Ÿ</div>
        </div>
    </section>
</div>

<script>
    /** ====== é…ç½®ä¸åŸºç¡€å°è£… ====== */
    const API = "http://localhost:8000/api/contacts";
    const TOKEN_KEY = "auth_token";
    const getToken = () => localStorage.getItem(TOKEN_KEY) || "";
    const setToken = (t) => localStorage.setItem(TOKEN_KEY, t);
    const clearToken = () => localStorage.removeItem(TOKEN_KEY);

    let _isRedirecting = false;
    async function apiFetch(url, options = {}) {
        const headers = { ...(options.headers || {}) };
        const tk = getToken();
        if (tk) headers.Authorization = `Bearer ${tk}`;
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401 && !/\/api\/auth\//.test(url) && !_isRedirecting) {
            _isRedirecting = true; clearToken(); goto("#/login");
        }
        return res;
    }
    const $ = (s) => document.querySelector(s);

    /** ====== è·¯ç”±ä¸é¡µé¢åˆ‡æ¢ ====== */
    function goto(hash){ location.hash = hash; }
    function syncMenu(hash){
        document.querySelectorAll(".menu a").forEach(a=>a.classList.remove("active"));
        if (hash.startsWith("#/home")) $("#nav-home").classList.add("active");
        else if (hash.startsWith("#/user")) $("#nav-user").classList.add("active");
        else if (hash.startsWith("#/about")) $("#nav-about").classList.add("active");
    }
    function showPage(id){
        ["#page-login","#page-home","#page-user","#page-about"].forEach(sel=>$(sel).classList.add("hidden"));
        $(id).classList.remove("hidden");
    }
    async function router(){
        const hash = location.hash || "#/home";
        syncMenu(hash);
        if (!getToken() && hash !== "#/login") { showPage("#page-login"); return; }
        if (hash === "#/login") { showPage("#page-login"); return; }
        if (hash.startsWith("#/home")) { showPage("#page-home"); await ensureMe(); await loadList(); return; }
        if (hash.startsWith("#/user")) { showPage("#page-user"); await ensureMe(); return; }
        if (hash.startsWith("#/about")) { showPage("#page-about"); return; }
    }
    window.addEventListener("hashchange", router);

    /** ====== ç™»å½• / æ³¨å†Œ / é€€å‡º ====== */
    $("#btn-login").onclick = async ()=>{
        const u = $("#lg-username").value.trim(), p = $("#lg-password").value.trim();
        if(!u || !p) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
        const r = await fetch(API.replace("/contacts","/auth/login"), {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ username:u, password:p })
        });
        const j = await r.json();
        if(!r.ok) return alert(j.error || "ç™»å½•å¤±è´¥");
        setToken(j.token);
        goto("#/home");
    };
    $("#btn-register").onclick = async ()=>{
        const u = $("#lg-username").value.trim(), p = $("#lg-password").value.trim();
        if(!u || !p) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
        const r = await fetch(API.replace("/contacts","/auth/register"), {
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ username:u, password:p })
        });
        const j = await r.json();
        if(!r.ok) return alert(j.error || "æ³¨å†Œå¤±è´¥");
        alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
    };
    $("#btn-logout").onclick = ()=>{ clearToken(); goto("#/login"); };

    /** ====== å…³äºé¡µï¼šå¥åº·æ£€æŸ¥ ====== */
    $("#btn-health").onclick = async ()=>{
        const r = await fetch("http://localhost:8000/api/health");
        $("#health-text").textContent = r.ok ? "âœ… åç«¯åœ¨çº¿" : "âŒ æ— æ³•è¿æ¥åç«¯";
    };

    /** ====== ç”¨æˆ·ä¿¡æ¯ ====== */
    async function ensureMe(){
        const r = await apiFetch(API.replace("/contacts","/auth/me"));
        if(!r.ok){ clearToken(); goto("#/login"); return; }
        const me = await r.json();
        $("#whoami").textContent = `å·²ç™»å½•ï¼š${me.username}`;
        $("#user-name").textContent = me.username;
    }

    /** ====== åˆ—è¡¨ / æœç´¢ / åˆ†é¡µ ====== */
    let allRows = [];       // åç«¯è¿”å›çš„å…¨éƒ¨ï¼ˆå½“å‰ç”¨æˆ·ï¼‰
    let viewRows = [];      // æœç´¢/æ’åºåçš„è§†å›¾
    let pageSize = 10, page = 1;

    function applyFilter(){
        const kw = $("#kw").value.trim().toLowerCase();
        viewRows = allRows.filter(r=>{
            const s = `${r.name||""} ${r.phone||""} ${r.email||""} ${r.note||""}`.toLowerCase();
            return !kw || s.includes(kw);
        });
        // æŒ‰å§“åæ’åºï¼Œå†æŒ‰ id
        viewRows.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "zh") || a.id - b.id);
        page = 1;
        render();
    }
    function render(){
        const total = viewRows.length;
        const start = (page-1)*pageSize, end = Math.min(start+pageSize, total);
        const rows = viewRows.slice(start, end);
        const tbody = $("#tbl tbody");
        if(!rows.length){
            tbody.innerHTML = `<tr><td colspan="7" class="muted" style="padding:14px">æš‚æ— æ•°æ®ï¼Œè¯•è¯•æ·»åŠ æˆ–ä¿®æ”¹æœç´¢æ¡ä»¶ã€‚</td></tr>`;
        }else{
            tbody.innerHTML = rows.map((r, i)=>`
      <tr data-id="${r.id}">
        <td><input type="checkbox" class="row-chk"></td>
        <td class="idx">${start + i + 1}</td>  <!-- é¡µé¢åºå· -->
        <td>${r.name||""}</td>
        <td>${r.phone||""}</td>
        <td>${r.email||""}</td>
        <td>${r.note||""}</td>
        <td>
          <button class="btn success" data-act="edit">ç¼–è¾‘</button>
          <button class="btn danger" data-act="del">åˆ é™¤</button>
        </td>
      </tr>`).join("");
        }
        $("#summary").textContent = `å…± ${total} æ¡ï¼Œæ˜¾ç¤º ${total? (start+1) : 0}-${end}`;
        renderPager(total);
        $("#chk-all").checked = false;
    }
    function renderPager(total){
        const pages = Math.max(1, Math.ceil(total/pageSize));
        const el = $("#pager"); el.innerHTML = "";
        const mk = (p, txt, cur=false)=>{
            const b = document.createElement("button"); b.textContent=txt; if(cur) b.classList.add("current");
            b.onclick = ()=>{ page=p; render(); };
            el.appendChild(b);
        };
        mk(Math.max(1,page-1), "ä¸Šä¸€é¡µ");
        for(let i=1;i<=pages;i++) mk(i, String(i), i===page);
        mk(Math.min(pages,page+1), "ä¸‹ä¸€é¡µ");
    }

    /** ====== æŠ˜å ç¼–è¾‘å™¨ ====== */
    const panelEdit = document.getElementById("panel-edit");
    function openEditor(){
        panelEdit.classList.remove("collapsed");
        resetForm();
        document.getElementById("name").focus();
        window.scrollTo({ top: panelEdit.offsetTop - 20, behavior: "smooth" });
    }
    function closeEditor(){ panelEdit.classList.add("collapsed"); }
    document.getElementById("btn-new").onclick = openEditor;

    /** ====== åŠ è½½ä¸ä¿å­˜ ====== */
    async function loadList(){
        const r = await apiFetch(API);
        if(!r.ok) return;
        allRows = await r.json();
        applyFilter();
    }
    function resetForm(){
        ["id","name","phone","email","note"].forEach(k=>$("#"+k).value="");
    }
    document.getElementById("resetBtn").onclick = ()=>{ resetForm(); closeEditor(); };

    document.getElementById("form").onsubmit = async (e)=>{
        e.preventDefault();
        const id = $("#id").value || null;
        const payload = {
            name: $("#name").value.trim(),
            phone: $("#phone").value.trim(),
            email: $("#email").value.trim(),
            note: $("#note").value.trim()
        };
        const r = await apiFetch(id? `${API}/${id}`: API, {
            method: id? "PUT":"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
        });
        const t = await r.json().catch(()=> ({}));
        if(!r.ok) return alert(t.error || "ä¿å­˜å¤±è´¥");
        resetForm();
        await loadList();
        closeEditor();                 // ä¿å­˜åè‡ªåŠ¨æ”¶èµ·
        alert("ä¿å­˜æˆåŠŸ");
    };

    document.getElementById("tbl").addEventListener("click", async (ev)=>{
        const btn = ev.target.closest("button"); if(!btn) return;
        const tr = ev.target.closest("tr");
        const id = tr.dataset.id;                 // çœŸå®æ•°æ®åº“ idï¼ˆç”¨äºè¯·æ±‚ï¼‰
        const act = btn.dataset.act;

        if(act==="edit"){
            $("#id").value = id;
            $("#name").value = tr.children[2].textContent.trim();
            $("#phone").value= tr.children[3].textContent.trim();
            $("#email").value= tr.children[4].textContent.trim();
            $("#note").value = tr.children[5].textContent.trim();
            openEditor();
        }else if(act==="del"){
            const seq = tr.querySelector(".idx")?.textContent || "?";   // é¡µé¢åºå·
            if(!confirm(`ç¡®å®šè¦åˆ é™¤ ç¬¬ ${seq} æ¡å—ï¼Ÿ`)) return;
            const r = await apiFetch(`${API}/${id}`, { method:"DELETE" });
            if(!r.ok) return alert("åˆ é™¤å¤±è´¥");
            await loadList();
        }
    });

    /** ====== å‹¾é€‰ & æ‰¹é‡åˆ é™¤ ====== */
    document.getElementById("chk-all").onchange = (e)=>{
        document.querySelectorAll(".row-chk").forEach(c=> c.checked = e.target.checked);
    };
    document.getElementById("btn-batch-del").onclick = async ()=>{
        const ids = Array.from(document.querySelectorAll(".row-chk:checked"))
            .map(c=> c.closest("tr").dataset.id);
        if(ids.length===0) return alert("è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„è¡Œ");
        if(!confirm(`ç¡®å®šæ‰¹é‡åˆ é™¤ ${ids.length} æ¡å—ï¼Ÿ`)) return;
        for(const id of ids){
            const r = await apiFetch(`${API}/${id}`, { method:"DELETE" });
            if(!r.ok){ alert(`åˆ é™¤å¤±è´¥ï¼ˆid=${id}ï¼‰`); break; }
        }
        await loadList();
    };

    /** ====== æœç´¢ ====== */
    document.getElementById("btn-search").onclick = applyFilter;
    document.getElementById("kw").addEventListener("keydown", e=>{ if(e.key==="Enter") applyFilter(); });

    /** ====== å¯¼å‡º CSVï¼ˆå½“å‰è¿‡æ»¤ç»“æœï¼‰ ====== */
    document.getElementById("btn-export").onclick = ()=>{
        const header = ["index","name","phone","email","note"]; // ç”¨ index ä»£æ›¿ id
        const lines = [header.join(",")].concat(
            viewRows.map((r, i)=> {
                const seq = i + 1; // è¿‡æ»¤åçš„å…¨é‡é¡ºåº
                const arr = [seq, r.name||"", r.phone||"", r.email||"", r.note||""];
                return arr.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(",");
            })
        );
        const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "contacts_export.csv";
        a.click();
        URL.revokeObjectURL(a.href);
    };

    /** ====== å¯¼å…¥ CSVï¼ˆname,phone,email,noteï¼‰ ====== */
    document.getElementById("csvFile").addEventListener("change", async (ev)=>{
        const file = ev.target.files[0]; if(!file) return;
        const text = await file.text();
        const rows = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
        let count = 0;
        for(let i=0;i<rows.length;i++){
            const cols = rows[i].split(",").map(s=> s.replace(/^"|"$/g,"").replace(/""/g,'"').trim());
            if(i===0 && ["name","phone","email","note"].every((k,j)=> (cols[j]||"").toLowerCase()===k)) continue; // è·³è¿‡è¡¨å¤´
            const [name,phone,email,note] = cols;
            if(!name || !phone) continue;
            const r = await apiFetch(API, {
                method:"POST", headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ name, phone, email, note })
            });
            if(r.ok) count++;
        }
        alert(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${count} æ¡`);
        ev.target.value = ""; // å…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
        await loadList();
    });

    /** ====== å¯åŠ¨ï¼šæ ¹æ® token è¿›å…¥å¯¹åº”é¡µ ====== */
    (async function init(){
        if(getToken()){ goto("#/home"); } else { goto("#/login"); }
        await router();
    })();
</script>
</body>
</html>
